"use strict";var app=angular.module("SbManifest");app.controller("loadCtrl",(function($rootScope,$scope,$q,$filter,$mdDialog,apiService,config){function isInLoad(item){try{var response=!1;return angular.forEach(item.GroupList,(function(value,key){angular.forEach(value.LoadList,(function(value,key){$.inArray(value.IdCustomer,$scope.moved.IdCustomer)>-1&&(response=!0)}))})),response}catch{}}$scope.loads,$scope.query={order:"",limit:5,page:1},$scope.rows,$scope.moved={},$scope.moved.IdCustomer=[],$scope.getLoadList=function(){var params={},url=config.manifestApi+"/load/list",promise;return apiService.getData(url,params,!0).then((function(data){$scope.loads=data.DataList}))},$scope.getSlotsLeft=function(seats,idLoad){try{if(null!=$scope.loads){var array=$filter("filter")($scope.loads,(function(item){return item.Id==idLoad}));angular.forEach(array,(function(value,key){angular.forEach(value.GroupList,(function(value,key){value&&(seats-=value.LoadList.length)}))}))}return seats}catch(error){return seats}},$scope.getLoadProfit=function(idLoad){try{var profit=0;if(null!=$scope.loads){var array=$filter("filter")($scope.loads,(function(item){return item.Id==idLoad}));angular.forEach(array,(function(value,key){angular.forEach(value.GroupList,(function(value,key){value&&angular.forEach(value.LoadList,(function(value,key){profit+=value.Profit}))}))}))}return profit}catch(error){}},$scope.init=function(){$scope.getLoadList()},$scope.addPeople=function($event,dto){dto.SlotsLeft=$scope.getSlotsLeft(dto.MaxSlots,dto.Id),$mdDialog.show({locals:{dataToPass:dto},controller:"addSlotCtrl",controllerAs:"ctrl",templateUrl:"app/components/load/addSlot.html",parent:angular.element(document.body),targetEvent:$event,clickOutsideToClose:!1}).then((function(){$scope.getLoadList()})).catch((function(){}))},$scope.showConfirm=function(passenger,productSlot,LoadNo){var confirm=$mdDialog.confirm().title("Would you like to delete "+passenger+"?").textContent("You will delete "+passenger+"-"+productSlot+"\n\rfrom Load "+LoadNo).ok("Delete").cancel("Cancel");$mdDialog.show(confirm).then((function(){$scope.status="Deleted"}),(function(){$mdDialog.hide()}))},$scope.confirmLoad=function($event,dto){var now=new Date;dto.scheduled=new Date(now.getTime()+12e5),$mdDialog.show({locals:{dataToPass:dto},controller:"confirmLoadCtrl",controllerAs:"ctrl",templateUrl:"app/components/load/confirmLoad.html",parent:angular.element(document.body),targetEvent:$event,clickOutsideToClose:!1}).then((function(){$scope.getLoadList()})).catch((function(){}))},$scope.editLoad=function($event,dto){if(!dto){dto={};var max=Math.max.apply(Math,$scope.loads.map((function(o){return o.Number})));dto.Number=max>0?max+1:1}$mdDialog.show({locals:{dataToPass:dto},controller:"editLoadCtrl",controllerAs:"ctrl",templateUrl:"app/components/load/editLoad.html",parent:angular.element(document.body),targetEvent:$event,clickOutsideToClose:!1}).then((function(){$scope.getLoadList()})).catch((function(){}))},$scope.beforeDrop=function(event,ui,item){var deferred=$q.defer();if($scope.loadMove!=item.Number)if($scope.moved.IdLoadFrom=$scope.loadMoveId,$scope.moved.IdLoadTo=item.Id,isInLoad(item)){var confirm=$mdDialog.alert().title($rootScope.messages.warning).textContent($scope.PassengerMove+" already In").ok("ok");$mdDialog.show(confirm).then((function(){$mdDialog.hide()}),(function(){$mdDialog.hide()}))}else{var confirm=$mdDialog.confirm().title("Would you like to move from Load "+$scope.loadMove+" to "+item.Number+" ?").textContent("You will move "+$scope.PassengerMove).ok("ok").cancel("Cancel");$mdDialog.show(confirm).then((function(){deferred.resolve()}),(function(){$mdDialog.hide()}))}return deferred.promise},$scope.startCallback=function(event,ui,item){$scope.PassengerMove=[],$scope.moved.IdCustomer=[],angular.forEach(item.LoadList,(function(value,key){console.log(value),$scope.loadMove=value.Number,$scope.loadMoveId=value.Id,$scope.moved.IdCustomer.push(value.IdCustomer),$scope.PassengerMove.push(value.Passenger)}))},$scope.dropCallback=function(event,ui){var url=config.manifestApi+"/load/slot/move";apiService.postData(url,$scope.moved,!0).then((function(data){$scope.moved={},$scope.moved.IdCustomer=[],$scope.getLoadList()}))}})),app.controller("confirmLoadCtrl",(function($scope,$state,$filter,$mdDialog,$window,dataToPass,apiService,config){var self=this;$scope.dto=dataToPass,this.cancel=function($event){$mdDialog.cancel()},this.save=function($event){var url=config.manifestApi+"/load/confirm";apiService.postData(url,$scope.dto,!0).then((function(){$mdDialog.hide()}))}})),app.controller("editLoadCtrl",(function($scope,$state,$filter,$mdDialog,$window,dataToPass,apiService,config){var self=this;$scope.warning=null,$scope.load=dataToPass,$scope.label=null==$scope.load?"Add new load":"Edit "+$scope.load.Name,this.cancel=function($event){$mdDialog.cancel()},this.save=function($event){var url=config.manifestApi+"/load/save";apiService.postData(url,$scope.load,!0).then((function(){$mdDialog.hide()}))},$scope.getAircrafts=function(){var url=config.manifestApi+"/settings/aircraft",promise;return apiService.getData(url,null,!1).then((function(data){$scope.aircraftList=data.DataList}))},$scope.setAircraft=function(dto){dto&&($scope.aircraftList=[{Id:dto.IdAircraft,Registration:dto.AircraftRegistration,Type:dto.AircraftType}])}}));