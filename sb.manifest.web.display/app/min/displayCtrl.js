"use strict";var app=angular.module("SbManifest");app.controller("displayCtrl",(function($scope,$interval,config,apiService){$scope.loads,$scope.connected=!1,$scope.showLoadList=!0,$scope.showPic=!1,$scope.pic="pictures/1.jpg";const displayTime=6e4;var i=-1;function loadAdvertisingData(){apiService.getData("config/advertising.json",null,!1).then((function(data){$scope.advertising=data}))}function swap(){$scope.$apply((function(){if($scope.showPic=!$scope.showPic,$scope.showLoadList=!$scope.showLoadList,$scope.showPic){if($scope.advertising){i++,$scope.advertising.length==i&&(i=0),$scope.pic=$scope.advertising[i].Src;var time=$scope.advertising[i].Time;setTimeout(swap,time)}}else setTimeout(swap,6e4)}))}function getLoadList(){var params={},url=config.manifestApi+"/load/list",promise;return apiService.getData(url,params,!0).then((function(data){$scope.loads=data.DataList,updateMinutesLeft()}))}loadAdvertisingData(),setTimeout(swap,6e4);var connection=(new signalR.HubConnectionBuilder).configureLogging(signalR.LogLevel.Debug).withUrl(config.displayHub,{skipNegotiation:!0,transport:signalR.HttpTransportType.WebSockets,accessTokenFactory:()=>sessionStorage.getItem("Authorization")}).build();function fadeHelp(){const helpBtn=angular.element("#help-btn")[0];let opacity=new Number(helpBtn.style.opacity);opacity>0&&(opacity=Math.max(opacity-.01,0),helpBtn.style.opacity=opacity,0==opacity&&(helpBtn.style.display="none"),setTimeout(fadeHelp,100))}function BodyOnKeyDown(e){if([68,70,72,52,100,53,101,54,102,107,109,187,189].includes(e.which)){const html=angular.element("html")[0];let fontSize=new Number(html.style.fontSize.replace("%",""));if(68==e.which)fontSize=6.25;else if(70==e.which)document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen();else if(72==e.which){const help=angular.element("#help");help.toggleClass("open")}else if([107,187].includes(e.which))fontSize+=.1;else if([109,189].includes(e.which))fontSize-=.1;else if([52,100,53,101,54,102].includes(e.which)){let cols=0;[52,100].includes(e.which)?cols=4:[53,101].includes(e.which)?cols=5:[54,102].includes(e.which)&&(cols=6),fontSize=6.25*document.body.clientWidth/(280*cols+8)}html.style.fontSize=fontSize+"%"}}function updateMinutesLeft(){try{angular.forEach($scope.loads,(function(value,key){value.DateDeparted&&(value.MinutesLeft=getTimeDiffInMInutes(value.DateDeparted))}))}catch(err){}}connection.start().then((function(){$scope.connected=!0})).catch((function(err){console.log(err)})),connection.on("messageReceived",(function(data){$scope.$apply((function(){$scope.loads=data.DataList}))})),$scope.getGroupClass=function(group){return"group g"+(group||0)},$scope.toggleHelp=function(){const help=angular.element("#help");help.toggleClass("open")},$scope.init=function(){getLoadList(),document.body.onkeydown=function(e){BodyOnKeyDown(e)},BodyOnKeyDown({which:68}),setTimeout(fadeHelp,1e4)},$interval(updateMinutesLeft,15e3)}));